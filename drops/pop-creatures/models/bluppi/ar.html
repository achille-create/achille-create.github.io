<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bluppi AR — Tuftpop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/aframe/mindar-image-aframe.prod.js"></script>
  <style>
    html,body{margin:0;overflow:hidden;background:#000;height:100%}
    #startBtn{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      padding:12px 18px;font-size:18px;border:none;border-radius:10px;
      background:#FFD82B;color:#111;z-index:10;font-weight:700
    }
    #toast{
      position:absolute;left:50%;bottom:16px;transform:translateX(-50%);
      color:#fff;background:#000a;padding:8px 12px;border-radius:8px;
      font-family:system-ui,arial,sans-serif;font-size:14px;z-index:11;display:none
    }
  </style>
</head>
<body>
  <button id="startBtn">▶️ Lancer l’expérience</button>
  <div id="toast"></div>

  <a-scene
    id="scene"
    mindar-image="imageTargetSrc: bluppi.mind; autoStart: false;"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    loading-screen="enabled: false"
  >
    <a-assets timeout="30000">
      <!-- Si tu as un MP4 transparent issu d’Alphavids -->
      <video id="bluppi-video"
             src="https://achille-create.github.io/assets/img/drop1/bluppi.mp4"
             autoplay loop muted playsinline crossorigin="anonymous"></video>
      <!-- Poster optionnel -->
      <img id="poster" src="../../../assets/img/brand/og.jpg">
    </a-assets>

    <a-camera position="0 0 0"></a-camera>

    <!-- Cible MindAR (targetIndex: 0 = première cible du fichier .mind) -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-video id="plane"
               src="#bluppi-video"
               width="1" height="1" position="0 0 0"
               material="transparent:true;"></a-video>
    </a-entity>
  </a-scene>

  <script>
    const btn   = document.getElementById('startBtn');
    const toast = document.getElementById('toast');
    const scene = document.getElementById('scene');
    const video = document.getElementById('bluppi-video');

    function say(msg){
      console.log(msg);
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(say._t);
      say._t = setTimeout(()=> toast.style.display='none', 2500);
    }

    // Attendre que la scène A-Frame soit prête
    scene.addEventListener('loaded', () => {
      say('Scène prête. Appuie pour démarrer.');
    });

    btn.addEventListener('click', async () => {
      try {
        // 1) Forcer une permission caméra dans un contexte utilisateur (iOS friendly)
        await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        say('Caméra OK');

        // 2) Démarrer MindAR via le SYSTEME (clé !)
        const arSystem = scene.systems['mindar-image-system'];
        if (!arSystem) {
          say('MindAR non initialisé'); 
          return;
        }
        await arSystem.start();  // démarre le tracking
        say('Tracking démarré');

        // 3) iOS exige souvent un play() manuel après un geste utilisateur
        try { await video.play(); } catch(e){ /* ignore */ }

        // 4) Cacher le bouton
        btn.style.display = 'none';
      } catch (err) {
        say('Caméra bloquée : ' + (err && err.name ? err.name : 'Erreur'));
      }
    });

    // Petit debug utile si la cible n’est pas reconnue
    scene.addEventListener('arReady', (e)=> say('AR prête'));
    scene.addEventListener('arError', (e)=> say('Erreur AR (permissions?)'));
  </script>
</body>
</html>
